<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ú—ã—Å–ª–∏ –∏ –°–∏–ª–∞</title>

  <!-- –ò–∫–æ–Ω–∫–∏ –∏ PWA -->
  <link rel="apple-touch-icon" sizes="180x180" href="icon.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon.png">
  <meta name="theme-color" content="#1a237e">
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(()=>console.log('SW ok'))
        .catch(e=>console.log('SW err', e));
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg-day1:#a0c4ff; --bg-day2:#b0bec5;
      --bg-night1:#1a237e; --bg-night2:#283593;
      --green:#4CAF50; --red:#f44336; --blue:#2196F3;
      --card:#ffffff; --muted:#888;
    }
    *{box-sizing:border-box}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin:0; padding:16px;
      min-height:100vh; display:flex; flex-direction:column;
      transition: background 1s; color:#fff; overflow:auto;
    }
    h1{margin:0 0 8px; text-align:center}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .card{
      background:rgba(255,255,255,0.08);
      backdrop-filter: blur(6px);
      border:1px solid rgba(255,255,255,0.15);
      border-radius:14px; padding:12px;
    }
    .controls .row > *{flex:1 1 auto}
    input, select, button{
      border:none; border-radius:10px; padding:10px 12px; font-size:15px;
    }
    input, select{background:#fff; color:#111}
    button{color:#fff; cursor:pointer}
    .btn-pos{background:var(--green)}
    .btn-neg{background:var(--red)}
    .btn-secondary{background:var(--blue)}
    .btn-ghost{background:transparent; border:1px solid rgba(255,255,255,0.3)}
    #thoughts{max-height:40vh; overflow:auto; padding-right:4px; scroll-behavior:smooth}
    .thought{
      background:rgba(255,255,255,0.1);
      border:1px solid rgba(255,255,255,0.15);
      border-radius:12px; padding:10px; margin-bottom:8px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:8px;
      animation:appear .35s ease;
    }
    @keyframes appear{from{opacity:0; transform:translateY(-6px)} to{opacity:1; transform:translateY(0)}}
    .left{display:flex; gap:8px; align-items:flex-start}
    .badge{padding:2px 8px; border-radius:999px; font-size:12px; white-space:nowrap}
    .badge-pos{background:rgba(76,175,80,.2); border:1px solid rgba(76,175,80,.5)}
    .badge-neg{background:rgba(244,67,54,.2); border:1px solid rgba(244,67,54,.5)}
    .meta{font-size:12px; color:rgba(255,255,255,0.7)}
    .actions{display:flex; gap:6px}
    .actions button{padding:6px 8px; font-size:13px; border-radius:8px}
    .edit{background:var(--blue)}
    .del{background:var(--red)}
    .transform{background:linear-gradient(90deg, #ff9800, #4CAF50)}
    .section-title{margin:12px 0 6px}
    .kpi{display:flex; gap:8px; flex-wrap:wrap}
    .kpi .pill{
      background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.15);
      padding:8px 10px; border-radius:12px; font-size:14px
    }
    .progress-wrap{margin:8px 0}
    .progress{
      background:rgba(255,255,255,.2); border-radius:999px; overflow:hidden; height:10px
    }
    .progress > div{
      height:100%; background:linear-gradient(90deg, #f44336, #4CAF50);
      width:0%
    }
    .filters .row > *{flex:1 1 160px}
    canvas{background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.15);
      border-radius:12px; padding:10px}
    /* Heatmap */
    .heatmap{display:grid; grid-template-columns: repeat(7, 1fr); gap:6px}
    .cell{
      aspect-ratio:1; border-radius:10px; display:flex; align-items:center; justify-content:center;
      font-size:10px; color:#111; border:1px solid rgba(0,0,0,.05)
    }
    .legend{display:flex; gap:8px; align-items:center; font-size:12px; color:#eee}
    .legend .box{width:16px; height:16px; border-radius:4px; border:1px solid rgba(255,255,255,.25)}
    .muted{color:rgba(255,255,255,.75)}
    /* small */
    @media (max-width: 420px){
      .actions{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <h1>–ú—ã—Å–ª–∏ –∏ –°–∏–ª–∞</h1>

  <!-- –í–≤–æ–¥ -->
  <div class="card controls">
    <div class="row">
      <input id="thoughtInput" type="text" placeholder="–ó–∞–ø–∏—à–∏ –º—ã—Å–ª—å..." />
      <select id="category">
        <option value="–¥–µ–Ω—å–≥–∏">üí∞ –î–µ–Ω—å–≥–∏</option>
        <option value="–æ—Ç–Ω–æ—à–µ–Ω–∏—è">‚ù§Ô∏è –û—Ç–Ω–æ—à–µ–Ω–∏—è</option>
        <option value="–∑–¥–æ—Ä–æ–≤—å–µ">üí™ –ó–¥–æ—Ä–æ–≤—å–µ</option>
        <option value="—Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ">üß† –°–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ</option>
        <option value="—Å–µ–º—å—è">üë®‚Äçüë©‚Äçüëß –°–µ–º—å—è</option>
        <option value="—Ä–∞–±–æ—Ç–∞">üìä –†–∞–±–æ—Ç–∞</option>
        <option value="–¥—Ä—É–≥–æ–µ" selected>‚ú® –î—Ä—É–≥–æ–µ</option>
      </select>
    </div>
    <div class="row">
      <button class="btn-pos" id="btnPos">–î–∞—ë—Ç —Å–∏–ª—É ‚úÖ</button>
      <button class="btn-neg" id="btnNeg">–ó–∞–±–∏—Ä–∞–µ—Ç —Å–∏–ª—É ‚ö°</button>
      <button class="btn-secondary" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      <input type="file" id="importFile" style="display:none" accept="application/json"/>
      <button class="btn-ghost" id="importBtn">–ò–º–ø–æ—Ä—Ç JSON</button>
    </div>
    <div class="progress-wrap">
      <div class="muted" id="energyLabel">–≠–Ω–µ—Ä–≥–∏—è –∑–∞ 7 –¥–Ω–µ–π: 0%</div>
      <div class="progress"><div id="energyBar"></div></div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi" id="kpiRow"></div>

  <!-- –°–ø–∏—Å–æ–∫ –º—ã—Å–ª–µ–π -->
  <h3 class="section-title">–î–Ω–µ–≤–Ω–∏–∫</h3>
  <div id="thoughts" class="card"></div>

  <!-- –§–∏–ª—å—Ç—Ä—ã –≥—Ä–∞—Ñ–∏–∫–∞ -->
  <h3 class="section-title">–ì—Ä–∞—Ñ–∏–∫</h3>
  <div class="card filters">
    <div class="row">
      <select id="period">
        <option value="7">–ù–µ–¥–µ–ª—è (7)</option>
        <option value="30">–ú–µ—Å—è—Ü (30)</option>
      </select>
      <select id="filterCategory">
        <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        <option value="–¥–µ–Ω—å–≥–∏">–î–µ–Ω—å–≥–∏</option>
        <option value="–æ—Ç–Ω–æ—à–µ–Ω–∏—è">–û—Ç–Ω–æ—à–µ–Ω–∏—è</option>
        <option value="–∑–¥–æ—Ä–æ–≤—å–µ">–ó–¥–æ—Ä–æ–≤—å–µ</option>
        <option value="—Å–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ">–°–∞–º–æ—Ä–∞–∑–≤–∏—Ç–∏–µ</option>
        <option value="—Å–µ–º—å—è">–°–µ–º—å—è</option>
        <option value="—Ä–∞–±–æ—Ç–∞">–†–∞–±–æ—Ç–∞</option>
        <option value="–¥—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
      </select>
      <label><input type="checkbox" id="showPos" checked> –ü–æ–∫–∞–∑–∞—Ç—å ¬´–¥–∞—ë—Ç¬ª</label>
      <label><input type="checkbox" id="showNeg" checked> –ü–æ–∫–∞–∑–∞—Ç—å ¬´–∑–∞–±–∏—Ä–∞–µ—Ç¬ª</label>
    </div>
  </div>

  <canvas id="chart" height="160"></canvas>

  <!-- –¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ -->
  <h3 class="section-title">–¢–µ–ø–ª–æ–≤–∞—è –∫–∞—Ä—Ç–∞ (30 –¥–Ω–µ–π)</h3>
  <div class="card">
    <div class="heatmap" id="heatmap"></div>
    <div class="legend" style="margin-top:8px;">
      <span>–ë–∞–ª–∞–Ω—Å</span>
      <span class="box" style="background:#f7b2b2"></span><span>–±–æ–ª—å—à–µ ¬´–∑–∞–±–∏—Ä–∞–µ—Ç¬ª</span>
      <span class="box" style="background:#f0f0f0"></span><span>–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ</span>
      <span class="box" style="background:#b6e3b6"></span><span>–±–æ–ª—å—à–µ ¬´–¥–∞—ë—Ç¬ª</span>
    </div>
  </div>

  <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
  <h3 class="section-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–µ—Ä–∏–æ–¥–∞</h3>
  <div id="insights" class="card muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>

  <script>
    // ===== –í–†–ï–ú–ï–ù–ù–û–ô –§–û–ù =====
    function setBackgroundByTime(){
      const h = new Date().getHours();
      document.body.style.background =
        (h>=6 && h<18)
        ? 'linear-gradient(to bottom, var(--bg-day1), var(--bg-day2))'
        : 'linear-gradient(to bottom, var(--bg-night1), var(--bg-night2))';
    }
    setBackgroundByTime();

    // ====== –î–ê–ù–ù–´–ï ======
    const storeKey='thoughts';
    let thoughts = JSON.parse(localStorage.getItem(storeKey) || '[]');

    // ====== UI ======
    const $ = s=>document.querySelector(s);
    const $$ = s=>document.querySelectorAll(s);
    const input = $('#thoughtInput');
    const categorySel = $('#category');
    const thoughtsBox = $('#thoughts');
    const periodSel = $('#period');
    const filterCatSel = $('#filterCategory');
    const showPos = $('#showPos');
    const showNeg = $('#showNeg');
    const energyBar = $('#energyBar');
    const energyLabel = $('#energyLabel');
    const kpiRow = $('#kpiRow');
    const heatmapBox = $('#heatmap');
    const insightsBox = $('#insights');

    $('#btnPos').onclick = ()=>saveThought('positive');
    $('#btnNeg').onclick = ()=>saveThought('negative');

    $('#exportBtn').onclick = ()=>{
      const blob = new Blob([JSON.stringify(thoughts,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'thoughts.json';
      a.click(); URL.revokeObjectURL(a.href);
    };
    $('#importBtn').onclick = ()=>$('#importFile').click();
    $('#importFile').addEventListener('change', e=>{
      const f=e.target.files[0]; if(!f) return;
      const r=new FileReader();
      r.onload=()=>{ try{
          const data = JSON.parse(r.result);
          if(Array.isArray(data)){ thoughts = data; persist(); fullRender(); }
        }catch(err){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON'); }
      };
      r.readAsText(f);
    });

    [periodSel, filterCatSel, showPos, showNeg].forEach(el=> el.addEventListener('change', ()=>{ drawChart(); renderInsights(); }));

    // ====== –°–û–•–†–ê–ù–ï–ù–ò–ï –ú–´–°–õ–ò ======
    function saveThought(type){
      const text = (input.value||'').trim();
      if(!text){ input.focus(); return; }
      const cat = categorySel.value;
      const now = new Date();
      thoughts.unshift({ text, type, category: cat, date: now.toISOString() });
      persist();
      input.value='';
      renderList();
      drawChart();
      renderHeatmap();
      renderKPIs();
      renderEnergy();
      renderInsights();
      // –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –∫ –Ω–∞—á–∞–ª—É —Å–ø–∏—Å–∫–∞
      thoughtsBox.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function persist(){ localStorage.setItem(storeKey, JSON.stringify(thoughts)); }

    // ====== –†–ï–ù–î–ï–† –°–ü–ò–°–ö–ê ======
    function renderList(){
      thoughtsBox.innerHTML='';
      thoughts.forEach((t,idx)=>{
        const div=document.createElement('div'); div.className='thought';
        const icon = t.type==='positive'?'‚úÖ':'‚ö°';
        const badgeClass = t.type==='positive'?'badge-pos':'badge-neg';
        div.innerHTML = `
          <div class="left">
            <div class="badge ${badgeClass}">${icon}</div>
            <div>
              <div>${escapeHtml(t.text)}</div>
              <div class="meta">${new Date(t.date).toLocaleString()} ‚Ä¢ ${t.category}</div>
            </div>
          </div>
          <div class="actions">
            <button class="edit">‚úèÔ∏è</button>
            <button class="transform">‚ö°‚Üí‚úÖ</button>
            <button class="del">üóëÔ∏è</button>
          </div>`;
        div.querySelector('.edit').onclick = ()=>editThought(idx);
        div.querySelector('.del').onclick = ()=>deleteThought(idx);
        div.querySelector('.transform').onclick = ()=>transformThought(idx);
        thoughtsBox.appendChild(div);
      });
    }
    function editThought(i){
      const t = thoughts[i];
      const newText = prompt('–ò–∑–º–µ–Ω–∏ –º—ã—Å–ª—å:', t.text);
      if(!newText) return;
      let newType = prompt('–¢–∏–ø —ç–Ω–µ—Ä–≥–∏–∏: positive/negative', t.type);
      if(newType!=='positive' && newType!=='negative') newType = t.type;
      thoughts[i] = {...t, text:newText, type:newType};
      persist(); fullRender();
    }
    function deleteThought(i){
      if(!confirm('–£–¥–∞–ª–∏—Ç—å –º—ã—Å–ª—å?')) return;
      thoughts.splice(i,1); persist(); fullRender();
    }
    function transformThought(i){
      const t = thoughts[i];
      if(t.type==='positive'){ alert('–û–Ω–∞ —É–∂–µ ‚úÖ'); return; }
      // –º–∏–Ω–∏-–∞–Ω–∏–º–∞—Ü–∏—è: –ø—Ä–æ—Å—Ç–æ —Å–º–µ–Ω–∞ —Ç–∏–ø–∞
      thoughts[i] = {...t, type:'positive'};
      persist(); fullRender();
    }

    // ====== –ì–†–ê–§–ò–ö ======
    let chart;
    function groupByDays(days, catFilter='all'){
      const map = {};
      const today = new Date();
      for(let i=days-1;i>=0;i--){
        const d=new Date(); d.setDate(today.getDate()-i);
        const key = d.toISOString().slice(0,10);
        map[key]={pos:0, neg:0};
      }
      thoughts.forEach(t=>{
        if(catFilter!=='all' && t.category!==catFilter) return;
        const key = (t.date||'').slice(0,10);
        if(map[key]){
          if(t.type==='positive') map[key].pos++;
          else map[key].neg++;
        }
      });
      const labels = Object.keys(map).sort();
      return {
        labels,
        positives: labels.map(k=>map[k].pos),
        negatives: labels.map(k=>map[k].neg)
      };
    }
    function drawChart(){
      const days = parseInt(periodSel.value,10);
      const cat = filterCatSel.value;
      const data = groupByDays(days, cat);

      const datasets=[];
      if(showPos.checked) datasets.push({label:'–î–∞—ë—Ç —Å–∏–ª—É', data:data.positives, borderColor:'#4CAF50', backgroundColor:'rgba(76,175,80,0.2)', tension:.3, fill:false});
      if(showNeg.checked) datasets.push({label:'–ó–∞–±–∏—Ä–∞–µ—Ç —Å–∏–ª—É', data:data.negatives, borderColor:'#f44336', backgroundColor:'rgba(244,67,54,0.2)', tension:.3, fill:false});

      // —Å—Ä–µ–¥–Ω–∏–µ –ª–∏–Ω–∏–∏
      const avg = arr => (arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0);
      if(showPos.checked){
        const ap = avg(data.positives);
        datasets.push({label:'–°—Ä–µ–¥–Ω–µ–µ (–¥–∞—ë—Ç)', data: Array(data.labels.length).fill(ap), borderColor:'rgba(76,175,80,.6)', borderDash:[6,6], tension:0, fill:false});
      }
      if(showNeg.checked){
        const an = avg(data.negatives);
        datasets.push({label:'–°—Ä–µ–¥–Ω–µ–µ (–∑–∞–±–∏—Ä–∞–µ—Ç)', data: Array(data.labels.length).fill(an), borderColor:'rgba(244,67,54,.6)', borderDash:[6,6], tension:0, fill:false});
      }

      if(chart) chart.destroy();
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx,{
        type:'line',
        data:{ labels: data.labels.map(s=>s.slice(5)), datasets },
        options:{
          responsive:true,
          plugins:{ legend:{ labels:{ color:'#fff' } } },
          scales:{
            x:{ ticks:{ color:'#fff' }, grid:{ color:'rgba(255,255,255,.15)' } },
            y:{ beginAtZero:true, ticks:{ color:'#fff' }, grid:{ color:'rgba(255,255,255,.15)' } }
          }
        }
      });
    }

    // ====== –¢–ï–ü–õ–û–í–ê–Ø –ö–ê–†–¢–ê (30 –¥–Ω–µ–π) ======
    function renderHeatmap(){
      const days=30;
      const data = groupByDays(days, 'all');
      // –±–∞–ª–∞–Ω—Å = pos - neg
      const balanceByDate = {};
      data.labels.forEach((d,i)=> balanceByDate[d] = (data.positives[i] - data.negatives[i]));
      heatmapBox.innerHTML='';
      // 7 –∫–æ–ª–æ–Ω–æ–∫ (–Ω–µ–¥–µ–ª–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ –Ω–µ —Å–æ–±–ª—é–¥–∞–µ–º, –ø—Ä–æ—Å—Ç–æ —Å–µ—Ç–∫–∞ –∏–∑ 7)
      Object.keys(balanceByDate).forEach(date=>{
        const bal = balanceByDate[date];
        const color = balanceColor(bal);
        const cell = document.createElement('div');
        cell.className='cell';
        cell.style.background = color;
        cell.title = `${date}: –±–∞–ª–∞–Ω—Å ${bal >=0 ? '+'+bal : bal}`;
        cell.textContent = new Date(date).getDate();
        heatmapBox.appendChild(cell);
      });
    }
    function balanceColor(b){
      // –æ—Ç -3..0..+3 –≤ –ø–∞—Å—Ç–µ–ª—å–Ω—ã–µ
      const clamp = (x,min,max)=> Math.max(min, Math.min(max,x));
      const v = clamp(b, -3, 3);
      if(v<0){
        const t = Math.abs(v)/3; // 0..1
        // –∫—Ä–∞—Å–Ω–æ–≤–∞—Ç—ã–π -> —Å–µ—Ä—ã–π
        return mix('#f7b2b2','#f0f0f0', 1-t);
      }else if(v>0){
        const t = v/3;
        // –∑–µ–ª—ë–Ω—ã–π -> —Å–µ—Ä—ã–π (–æ–±—Ä–∞—Ç–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è)
        return mix('#b6e3b6','#f0f0f0', 1-t);
      }
      return '#f0f0f0';
    }
    function mix(c1,c2,t){
      const a = hexToRgb(c1), b = hexToRgb(c2);
      const m = { r:Math.round(a.r*(1-t)+b.r*t), g:Math.round(a.g*(1-t)+b.g*t), b:Math.round(a.b*(1-t)+b.b*t) };
      return `rgb(${m.r},${m.g},${m.b})`;
    }
    function hexToRgb(h){
      const x = h.replace('#','');
      const n = x.length===3
        ? x.split('').map(s=>parseInt(s+s,16))
        : [x.slice(0,2),x.slice(2,4),x.slice(4,6)].map(s=>parseInt(s,16));
      return {r:n[0], g:n[1], b:n[2]};
    }

    // ====== KPI / –≠–ù–ï–†–ì–ò–Ø / –ò–ù–°–ê–ô–¢–´ ======
    function renderKPIs(){
      const total = thoughts.length;
      const pos = thoughts.filter(t=>t.type==='positive').length;
      const neg = thoughts.filter(t=>t.type==='negative').length;
      const last7 = groupByDays(7,'all');
      const last7count = last7.positives.reduce((a,b)=>a+b,0)+last7.negatives.reduce((a,b)=>a+b,0);

      kpiRow.innerHTML = `
        <div class="pill">–í—Å–µ–≥–æ –º—ã—Å–ª–µ–π: <b>${total}</b></div>
        <div class="pill">–î–∞—ë—Ç —Å–∏–ª—ã: <b>${pos}</b></div>
        <div class="pill">–ó–∞–±–∏—Ä–∞–µ—Ç —Å–∏–ª—ã: <b>${neg}</b></div>
        <div class="pill">–ó–∞ 7 –¥–Ω–µ–π: <b>${last7count}</b></div>
      `;
    }
    function renderEnergy(){
      const g = groupByDays(7,'all');
      const pos = g.positives.reduce((a,b)=>a+b,0);
      const neg = g.negatives.reduce((a,b)=>a+b,0);
      const total = pos+neg;
      const pct = total ? Math.round((pos/total)*100) : 0;
      energyBar.style.width = pct+'%';
      energyLabel.textContent = `–≠–Ω–µ—Ä–≥–∏—è –∑–∞ 7 –¥–Ω–µ–π: ${pct}% (‚úÖ ${pos} / ‚ö° ${neg})`;
    }
    function renderInsights(){
      const days = parseInt(periodSel.value,10);
      const cat = filterCatSel.value;
      const g = groupByDays(days, cat);
      const pos = g.positives.reduce((a,b)=>a+b,0);
      const neg = g.negatives.reduce((a,b)=>a+b,0);
      const total = pos+neg;
      if(!total){ insightsBox.textContent='–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.'; return; }
      const pct = Math.round(pos/total*100);

      // —Ç–æ–ø-–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥
      const byCat = {};
      thoughts.forEach(t=>{
        const d = t.date.slice(0,10);
        if(!g.labels.includes(d)) return;
        byCat[t.category] = byCat[t.category] || {pos:0,neg:0};
        if(t.type==='positive') byCat[t.category].pos++;
        else byCat[t.category].neg++;
      });
      const top = Object.entries(byCat).sort((a,b)=> (b[1].pos+b[1].neg) - (a[1].pos+a[1].neg)).slice(0,3);

      // —Å–∏–ª—å–Ω—ã–µ/—Å–ª–∞–±—ã–µ –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏
      const weekday = (d)=> ['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'][new Date(d).getDay()];
      const byDay = {};
      g.labels.forEach((d,i)=>{
        const key = weekday(d);
        byDay[key] = byDay[key] || {pos:0,neg:0};
        byDay[key].pos += g.positives[i];
        byDay[key].neg += g.negatives[i];
      });
      const dayScore = Object.entries(byDay).map(([k,v])=>[k, (v.pos - v.neg)]);
      dayScore.sort((a,b)=>b[1]-a[1]);
      const best = dayScore[0]?.[0] || '‚Äî';
      const worst = dayScore[dayScore.length-1]?.[0] || '‚Äî';

      insightsBox.innerHTML = `
        <div>–ó–∞ –ø–µ—Ä–∏–æ–¥: <b>${total}</b> –º—ã—Å–ª–µ–π ‚Äî ‚úÖ <b>${pos}</b>, ‚ö° <b>${neg}</b> ‚Ä¢ –ü–æ–∑–∏—Ç–∏–≤–∞: <b>${pct}%</b></div>
        <div style="margin-top:6px;">–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</div>
        <ul style="margin:6px 0 0 18px;">
          ${top.map(([c,v])=>`<li>${c}: ${v.pos+v.neg} (‚úÖ ${v.pos} / ‚ö° ${v.neg})</li>`).join('') || '<li>–ù–µ—Ç</li>'}
        </ul>
        <div style="margin-top:6px;">–°–∏–ª—å–Ω—ã–π –¥–µ–Ω—å: <b>${best}</b> ‚Ä¢ –°–ª–∞–±—ã–π –¥–µ–Ω—å: <b>${worst}</b></div>
      `;
    }

    // ====== –£–¢–ò–õ–ò–¢–´ ======
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }

    // ====== –ü–ï–†–í–ò–ß–ù–´–ô –†–ï–ù–î–ï–† ======
    function fullRender(){
      renderList(); drawChart(); renderHeatmap(); renderKPIs(); renderEnergy(); renderInsights();
    }
    fullRender();
  </script>
</body>
</html>
